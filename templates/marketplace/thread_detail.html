{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Messages" %}{% endblock %}

{% block content %}
<h1>{% trans "Conversation" %}</h1>
<p class="helptext">{% trans "With:" %} <strong>{{ counterparty.display_name }}</strong></p>

<section>
    <h2>{% trans "Item details" %}</h2>
    <dl>
        {% if user.role == "buyer" %}
        <dt>{% trans "Supply" %}</dt><dd>{{ thread.watchlist_item.supply_lot.item_text }}</dd>
        {% if thread.watchlist_item.supply_lot.quantity_value %}<dt>{% trans "Quantity" %}</dt><dd>{{ thread.watchlist_item.supply_lot.quantity_value }} {{ thread.watchlist_item.supply_lot.get_quantity_unit_display }}</dd>{% endif %}
        <dt>{% trans "Location" %}</dt><dd>{{ thread.watchlist_item.supply_lot.location_country }}{% if thread.watchlist_item.supply_lot.location_locality %}, {{ thread.watchlist_item.supply_lot.location_locality }}{% endif %}</dd>
        {% if thread.watchlist_item.supply_lot.asking_price %}<dt>{% trans "Asking price" %}</dt><dd>${{ thread.watchlist_item.supply_lot.asking_price }}/{{ thread.watchlist_item.supply_lot.get_price_unit_display }}</dd>{% endif %}
        <dt>{% trans "Shipping" %}</dt><dd>{{ thread.watchlist_item.supply_lot.get_shipping_scope_display }}</dd>
        {% else %}
        <dt>{% trans "Demand" %}</dt><dd>{{ thread.watchlist_item.demand_post.item_text }}</dd>
        {% if thread.watchlist_item.demand_post.quantity_value %}<dt>{% trans "Quantity" %}</dt><dd>{{ thread.watchlist_item.demand_post.quantity_value }} {{ thread.watchlist_item.demand_post.get_quantity_unit_display }}</dd>{% endif %}
        <dt>{% trans "Location" %}</dt><dd>{{ thread.watchlist_item.demand_post.location_country }}{% if thread.watchlist_item.demand_post.location_locality %}, {{ thread.watchlist_item.demand_post.location_locality }}{% endif %}</dd>
        {% endif %}
    </dl>
</section>

<div class="messages-list">
    {% for msg in messages_list %}
    <div class="message {% if msg.sender == user %}sent{% else %}received{% endif %}">
        <strong>{{ msg.sender.display_name }}</strong>
        <span>{{ msg.created_at|date:"SHORT_DATETIME_FORMAT" }}</span>
        <p>{{ msg.body }}</p>
    </div>
    {% empty %}
    <p class="empty-state">{% trans "No messages yet. Start the conversation!" %}</p>
    {% endfor %}
</div>

{% if listing_deleted %}
<div class="card">
    <p class="empty-state">{% trans "This listing has been deleted. Messaging is closed." %}</p>
</div>
{% else %}
<div class="card">
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">{% trans "Send" %}</button>
    </form>
</div>
{% endif %}

<div class="actions">
    <a href="{% url 'marketplace:watchlist' %}" class="btn btn-secondary">{% trans "Back to watchlist" %}</a>
</div>
{% endblock %}
