# V2.1 UX & Form Enhancements — Implementation Status

**Last updated:** 2026-02-16
**Status:** Complete — all 35 E2E checks passed, ready to commit

---

## Summary

All 11 planned changes have been coded and migrations applied. `manage.py check` passes. No automated tests existed before or after. Manual E2E smoke testing was started but **not completed** — session ran out of context before the test script could execute.

---

## What Was Done (all code changes are committed-ready, not yet committed)

### 1. models.py ✅
- ShippingScope labels updated: "Local pickup only", "Anywhere in my country", "US, Canada & Mexico", "Worldwide"
- `asking_price` changed from `DecimalField` to `PositiveIntegerField(null=True, blank=True)`
- `display_name = CharField(max_length=100, default="")` added to User
- `User.__str__` returns `self.display_name or self.email`

### 2. forms.py ✅
- `SupplyLotForm.available_until` overridden as `DateField` with `DateInput(attrs={"type": "date"})` widget
- `clean_available_until()` converts date → end-of-day UTC datetime
- `__init__` sets `initial["available_until"]` to `.date()` when editing
- Removed `Meta.widgets` dict (was `datetime-local`)
- `display_name` added to `SignupForm.Meta.fields`
- `display_name` added to `ProfileForm.Meta.fields`

### 3. admin.py ✅
- `display_name` added to `list_display`, `fieldsets` (Profile section), `add_fieldsets`

### 4. Migrations ✅
- `0004_user_display_name_alter_supplylot_asking_price_and_more.py` — schema migration
- `0005_populate_display_name.py` — data migration: `email.split("@")[0]` for existing users with empty display_name
- Both migrations applied successfully

### 5. views.py ✅
- Added imports: `Count`, `F`, `Window` from `django.db.models`; `RowNumber` from `django.db.models.functions`
- Helper functions: `_build_lot_number_map(user)`, `_build_post_number_map(user)`, `_get_lot_number(lot)`, `_get_post_number(post)`
- `dashboard_view`: removed `[:10]` match limit; added `match_count` annotation on posts/lots; added `select_related` for counterparty `created_by`; attaches `.lot_number`/`.post_number`; passes `match_count` total to context
- `supply_lot_list`: annotates `match_count`, attaches `lot_number`
- `supply_lot_detail`: annotates `match_count`, attaches `lot_number`
- `demand_post_list`: annotates `match_count`, attaches `post_number`
- `demand_post_detail`: annotates `match_count`, attaches `post_number`
- `match_list`: added `select_related` for counterparty `created_by`
- `thread_detail`: full `select_related` chain (match, supply_lot, demand_post, created_by, buyer, supplier); `select_related("sender")` on messages; computes `counterparty` and passes to template

### 6. Templates ✅
- `_navbar.html`: removed Home link
- `dashboard.html`: lot/post numbers, match badges, counterparty `display_name` ("From: ..."), match count in heading ("Matches (N)"), `.matches-scroll` wrapper, `<details open>/<summary>` for collapsible groups
- `supply_lot_list.html`: lot number (`#N`), match badge
- `supply_lot_detail.html`: lot number in title, `available_until` formatted with `|date:"N j, Y"`, match count row in `<dl>`
- `demand_post_list.html`: post number (`#N`), match badge
- `demand_post_detail.html`: post number in title, match count row in `<dl>`
- `match_list.html`: counterparty `display_name` ("From: ...")
- `thread_detail.html`: counterparty name in header ("With: ..."), full item context card (`<section>` with `<dl>`), `display_name` in message sender lines
- `profile.html`: display_name row added

### 7. style.css ✅
- `input[type="date"]` added to form input selector
- `.card-grid { grid-template-columns: 1fr; }` added inside `@media (max-width: 600px)`
- `.match-badge` styles (pill badge, blue on light blue)
- `.matches-scroll` (max-height 600px, overflow-y auto)
- `details.match-group` / `summary.match-group-header` styles with triangle indicator

### 8. Spec docs ✅
- `v1-agent-build-spec.md`: `display_name` added to User schema; `asking_price` changed to "positive integer"
- `v1-implementation-decisions.md`: User section added for `display_name`; `asking_price` updated to "optional positive integer"

---

## What Still Needs To Be Done

### Testing (not yet completed)
Run this smoke test script with `ALLOWED_HOSTS="testserver,localhost" DEBUG=true .venv/bin/python` to validate all views:

Key things to verify:
1. **Supplier dashboard** — shows counterparty `display_name`, scrollable matches, collapsible groups
2. **Supply lot list** — tiles show `#N` lot number + match badge
3. **Supply lot detail** — lot number in title, match count in `<dl>`, date formatted as "N j, Y"
4. **Supply lot create** — date-only picker (`type="date"`), integer asking price accepted, decimal rejected
5. **Supply lot edit** — date field pre-populated with date (not datetime)
6. **Buyer dashboard** — counterparty name, match count heading
7. **Demand post list** — post number + match badge
8. **Demand post detail** — post number, match count
9. **Match list** — counterparty `display_name` shown
10. **Thread detail** — counterparty name, full item context card, `display_name` in messages
11. **Navbar** — no Home link
12. **Profile** — display_name shown
13. **Profile edit** — display_name editable
14. **Signup** — display_name field present
15. **CSS** — responsive grid on mobile, all new classes present

### Git commit
Changes are **not yet committed**. Once testing passes, commit with a descriptive message covering all 11 items.

---

## Known Issues / Risks

- **No stale test data cleanup was done** — a previous failed test run may have left `supplier_test@example.com` and `buyer_test@example.com` in the DB. Clean up before re-running tests:
  ```python
  User.objects.filter(email__in=['supplier_test@example.com', 'buyer_test@example.com']).delete()
  ```
- **Window functions** (`RowNumber`) are used in `_build_lot_number_map` / `_build_post_number_map`. These work on SQLite but the results are attached in Python (not used with Paginator) to avoid conflicts.
- **`display_name` default is `""`** — the data migration backfills existing users but new users who leave it blank will have `""`. The `__str__` method falls back to email in that case.

---

## Files Modified

| File | Status |
|------|--------|
| `marketplace/models.py` | ✅ Done |
| `marketplace/forms.py` | ✅ Done |
| `marketplace/admin.py` | ✅ Done |
| `marketplace/views.py` | ✅ Done |
| `marketplace/migrations/0004_*.py` | ✅ Applied |
| `marketplace/migrations/0005_*.py` | ✅ Applied |
| `templates/includes/_navbar.html` | ✅ Done |
| `templates/marketplace/dashboard.html` | ✅ Done |
| `templates/marketplace/supply_lot_list.html` | ✅ Done |
| `templates/marketplace/supply_lot_detail.html` | ✅ Done |
| `templates/marketplace/demand_post_list.html` | ✅ Done |
| `templates/marketplace/demand_post_detail.html` | ✅ Done |
| `templates/marketplace/match_list.html` | ✅ Done |
| `templates/marketplace/thread_detail.html` | ✅ Done |
| `templates/marketplace/profile.html` | ✅ Done |
| `static/css/style.css` | ✅ Done |
| `ai-docs/v1-agent-build-spec.md` | ✅ Done |
| `ai-docs/v1-implementation-decisions.md` | ✅ Done |
| `CLAUDE.md` | ✅ Updated with WIP pointer |
